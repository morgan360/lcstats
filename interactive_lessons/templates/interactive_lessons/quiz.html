{% extends "_base.html" %}
{% load solution_filters %}
{% block title %}{{ topic.name }} | LCAI Maths{% endblock %}

{% block content %}
    <div class="card" style="max-width:750px; margin:0 auto; padding:20px;" data-topic-slug="{{ topic.slug }}">
        <h2 style="color:#004aad; margin-bottom:0.4em;">{{ topic.name }}</h2>
        <p style="margin:0; font-weight:600;">Question {{ index }} of {{ total }}</p>

        {% if question.section %}
            <h3 style="color:#004aad; font-size:1.1em; margin-top:0.4em;">{{ question.section }}</h3>
        {% endif %}

        <!-- Collapsible Hint (Question Area) -->
        <div style="margin-top:10px;">
            <details style="background-color:#fff8dc; border:1px solid #f0d98c; border-radius:6px; padding:12px;">
                <summary style="cursor:pointer; font-weight:600; color:#004aad;">üí° Hint</summary>
                <div style="margin-top:10px; white-space:pre-wrap; line-height:1.6;">
                    {{ question.hint|safe }}
                </div>

                {% with img=question.get_image %}
                    {% if img %}
                        <div style="margin-top:10px; text-align:center;">
                            <img src="{{ img }}" alt="Question image"
                                 style="max-width:75%; height:auto; border-radius:6px;">
                        </div>
                    {% endif %}
                {% endwith %}
            </details>
        </div>

        <!-- Each QuestionPart -->
        {% for part in parts %}
            <div id="part-{{ part.id }}"
                 style="margin-top:1.2em; border-top:1px solid #eee; padding-top:1em; background-color:#f7f7f7; border-radius:8px; padding:12px;">

                <!-- Inline label + question prompt -->
                <div style="display:flex; align-items:flex-start; gap:6px;">
                    <div style="font-weight:bold; color:#004aad; min-width:32px;">{{ part.label }}</div>
                    <div style="flex:1;">{{ part.prompt|safe }}</div>
                </div>

                <!-- QuestionPart Image -->
                {% if part.image %}
                    <div style="margin-top:10px; text-align:center;">
                        <img src="{{ part.image.url }}" alt="Question part image"
                             style="max-width:75%; height:auto; border-radius:6px; border:1px solid #ddd;">
                    </div>
                {% endif %}

                <!-- ‚ú® Expected Answer Format Box -->
                {% if part.expected_format %}
                    <details
                            style="margin-top:8px; background-color:#f0f7ff; border:1px solid #cfe2ff; border-radius:5px; padding:8px;">
                        <summary style="font-weight:600; color:#004aad; cursor:pointer;">üí≠ Expected Answer Format
                        </summary>
                        <div style="margin-top:6px; line-height:1.5;">
                            {{ part.expected_format|safe }}
                        </div>
                    </details>
                {% endif %}

                <!-- Math input -->
                <math-field id="mf-{{ part.id }}"
                            style="width:100%; font-size:1.15em; border:1px solid #ccc;
                         border-radius:6px; padding:6px; margin-top:8px; display:block;"></math-field>

                <!-- Buttons and feedback -->
                <div style="margin-top:8px; display:flex; align-items:center; gap:10px;">
                    <button type="button" class="btn check-btn" data-part="{{ part.id }}"
                            style="background-color:#004aad; color:white;">
                        Check Answer
                    </button>
                    <div id="feedback-{{ part.id }}" style="display:none; font-size:0.95em;"></div>
                </div>

                <!-- Part Solution -->
                {% if part.solution %}
                    <details style="margin-top:10px; background-color:#e8f5e9; border:1px solid #a5d6a7; border-radius:5px; padding:10px;">
                        <summary style="font-weight:600; color:#2e7d32; cursor:pointer;">üìù Solution for {{ part.label }}</summary>
                        <div style="margin-top:8px; line-height:1.6;">
                            {{ part.solution|safe }}
                        </div>
                    </details>
                {% endif %}

                <!-- Animated Step-by-Step Solution -->
                {% if part.id in animated_solutions %}
                    <details style="margin-top:10px; background-color:#fff3e0; border:1px solid #ffb74d; border-radius:5px; padding:10px;">
                        <summary style="font-weight:600; color:#e65100; cursor:pointer;">üé¨ Step-by-Step Solution</summary>
                        <div id="animated-solution-{{ part.id }}" style="margin-top:10px;"></div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const solutionData_{{ part.id }} = {{ animated_solutions|get_item:part.id|safe }};
                                if (solutionData_{{ part.id }}) {
                                    new AnimatedSolutionViewer('animated-solution-{{ part.id }}', solutionData_{{ part.id }});
                                }
                            });
                        </script>
                    </details>
                {% endif %}
            </div>
        {% endfor %}

        <!-- Full question solution -->
        {% if question.solution %}
            <div id="solution-wrapper" style="margin-top:25px; border-top:1px solid #ddd; padding-top:15px;">
                <button id="show-solution-btn" class="btn"
                        style="background-color:#00994c; color:white; padding:6px 12px;">
                    üíö Show Full Solution
                </button>

                <div id="solution-content"
                     style="display:none; margin-top:15px; line-height:1.6;">
                    {{ question.solution|safe }}

                    {% if question.solution_image %}
                        <div style="margin-top:15px; text-align:center;">
                            <img src="{{ question.solution_image.url }}" alt="Solution image"
                                 style="max-width:75%; height:auto; border-radius:8px;">
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Next button -->
        <div id="next-btn-wrapper" style="margin-top:20px; display:none;">
            <form method="POST">
                {% csrf_token %}
                <button type="submit" name="next" class="btn"
                        style="background-color:#00994c; color:white;">Next ‚Üí
                </button>
            </form>
        </div>
    </div>

    <!-- InfoBot and Contact Section -->
    <div style="max-width:750px; margin:30px auto; padding:20px; background-color:#f0f8ff; border:1px solid #b3d9ff; border-radius:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 style="color:#004aad; margin:0;">ü§ñ Ask InfoBot</h3>
            <a href="{% url 'question_contact' question.id %}"
               class="btn"
               style="background-color:#00994c; color:white; padding:6px 12px; text-decoration:none; font-size:0.9em; border-radius:4px;">
                üìß Contact Teacher
            </a>
        </div>
        <p style="margin:0 0 12px 0; font-size:0.9em; color:#555;">
            Need help with this topic? Ask a question and get instant answers from our AI tutor.
        </p>

        <div style="display:flex; gap:8px; align-items:flex-start;">
            <input type="text"
                   id="infobot-query"
                   placeholder="e.g., What is the quadratic formula?"
                   style="flex:1; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:1em;">
            <button id="infobot-ask-btn"
                    class="btn"
                    style="background-color:#004aad; color:white; padding:10px 20px; white-space:nowrap;">
                Ask
            </button>
        </div>

        <div id="infobot-answer"
             style="margin-top:15px; padding:15px; background-color:white; border-radius:6px; display:none; line-height:1.6;">
            <!-- Answer will be inserted here -->
        </div>

        <div id="infobot-loading"
             style="margin-top:15px; color:#004aad; display:none;">
            üîÑ Thinking...
        </div>
    </div>

    <hr style="margin-top:30px; max-width:750px; margin-left:auto; margin-right:auto;">

    <!-- Navigation -->
    <div style="max-width:750px; margin:0 auto; display:flex; justify-content:space-between; align-items:center;">
        {% if index > 1 %}
            <a href="{% url 'question_view' topic.id index|add:'-1' %}" class="btn"
               style="background-color:#004aad; color:white; padding:6px 14px; border-radius:4px; text-decoration:none;">
                ‚¨Ö Previous
            </a>
        {% else %}
            <span></span>
        {% endif %}

        {% if index < total %}
            <a href="{% url 'question_view' topic.id index|add:'1' %}" class="btn"
               style="background-color:#00994c; color:white; padding:6px 14px; border-radius:4px; text-decoration:none;">
                Skip ‚û°
            </a>
        {% else %}
            <a href="{% url 'topic_complete' topic.name %}" class="btn"
               style="background-color:#cc0000; color:white; padding:6px 14px; border-radius:4px; text-decoration:none;">
                üõë Finish
            </a>
        {% endif %}

    </div>

    <!-- Question index -->
    <div style="text-align:center; margin-top:20px;">
        {% for q in questions %}
            {% if forloop.counter == index %}
                <span style="font-weight:bold; color:#004aad;">{{ forloop.counter }}</span>
            {% else %}
                <a href="{% url 'question_view' topic.id forloop.counter %}"
                   style="color:#333; text-decoration:none;">{{ forloop.counter }}</a>
            {% endif %}
            {% if not forloop.last %} | {% endif %}
        {% endfor %}
    </div>
{% endblock %}

{% block extra_head %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'interactive_lessons/animated-solution.css' %}">
    <!-- GeoGebra API -->
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>
{% endblock %}

{% block extra_scripts %}
    {% load static %}
    <script src="{% static 'interactive_lessons/animated-solution.js' %}"></script>
    <script src="{% static 'interactive_lessons/quiz.js' %}"></script>
{% endblock %}
