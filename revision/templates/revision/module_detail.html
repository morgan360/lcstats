{% extends '_base.html' %}
{% load static %}

{% block title %}{{ page_title }} - NumScoil{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 0 auto; padding: 20px;">
    <!-- Module Header -->
    <div style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 15px;
        margin-bottom: 40px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    ">
        <div style="
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 15px;
        ">
            üìñ {{ module.topic.name }}
        </div>
        <h1 style="margin: 0 0 15px 0; font-size: 2.2em;">{{ module.title }}</h1>
        {% if module.description %}
            <p style="
                font-size: 1.1em;
                opacity: 0.95;
                margin: 0;
                line-height: 1.6;
            ">
                {{ module.description }}
            </p>
        {% endif %}
    </div>

    <!-- Navigation Breadcrumb -->
    <div style="margin-bottom: 30px; color: #666; font-size: 0.95em;">
        <a href="{% url 'module_list' %}" style="color: #1976d2; text-decoration: none;">‚Üê Back to all modules</a>
    </div>

    <!-- Sections -->
    {% if sections %}
        {% for section in sections %}
            <div class="revision-section" style="
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                padding: 35px;
                margin-bottom: 30px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            ">
                <h2 style="
                    color: #2c3e50;
                    margin-top: 0;
                    margin-bottom: 25px;
                    font-size: 1.6em;
                    padding-bottom: 15px;
                    border-bottom: 3px solid #667eea;
                ">
                    {{ section.title }}
                </h2>

                <!-- Text Content -->
                {% if section.text_content %}
                    <div class="text-content" style="
                        line-height: 1.8;
                        color: #333;
                        margin-bottom: 25px;
                        font-size: 1.05em;
                    ">
                        {{ section.text_content|linebreaks }}
                    </div>
                {% endif %}

                <!-- Image -->
                {% if section.image %}
                    <div class="image-content" style="margin-bottom: 25px; text-align: center;">
                        <img src="{{ section.image.url }}"
                             alt="{{ section.image_caption|default:'Section image' }}"
                             style="
                                 max-width: 100%;
                                 height: auto;
                                 border-radius: 8px;
                                 box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                             ">
                        {% if section.image_caption %}
                            <p style="
                                margin-top: 12px;
                                font-style: italic;
                                color: #666;
                                font-size: 0.95em;
                            ">
                                {{ section.image_caption }}
                            </p>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- GeoGebra -->
                {% if section.geogebra_enabled and section.geogebra_material_id %}
                    <div class="geogebra-content" style="
                        margin-bottom: 25px;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid #667eea;
                    ">
                        <div style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 15px;
                            color: #667eea;
                            font-weight: 600;
                        ">
                            <span style="font-size: 1.3em; margin-right: 10px;">üìê</span>
                            <span>Interactive GeoGebra Visualization</span>
                        </div>
                        <div id="geogebra-{{ section.id }}" style="
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            overflow: hidden;
                            background: white;
                        "></div>
                    </div>
                {% endif %}

                <!-- Video -->
                {% if section.video_enabled and section.video_url %}
                    <div class="video-content" style="
                        margin-bottom: 25px;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid #e91e63;
                    ">
                        <div style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 15px;
                            color: #e91e63;
                            font-weight: 600;
                        ">
                            <span style="font-size: 1.3em; margin-right: 10px;">üé•</span>
                            <span>Video Tutorial</span>
                        </div>
                        <div style="
                            position: relative;
                            padding-bottom: 56.25%;
                            height: 0;
                            overflow: hidden;
                            border-radius: 8px;
                            background: #000;
                        ">
                            {% if 'youtube.com' in section.video_url or 'youtu.be' in section.video_url %}
                                <!-- YouTube embed -->
                                {% if 'watch?v=' in section.video_url %}
                                    <iframe
                                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                        src="https://www.youtube.com/embed/{{ section.video_url|slice:'32:' }}"
                                        frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen>
                                    </iframe>
                                {% elif 'youtu.be' in section.video_url %}
                                    <iframe
                                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                        src="https://www.youtube.com/embed/{{ section.video_url|slice:'-11:' }}"
                                        frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen>
                                    </iframe>
                                {% endif %}
                            {% elif 'vimeo.com' in section.video_url %}
                                <!-- Vimeo embed -->
                                <iframe
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                    src="https://player.vimeo.com/video/{{ section.video_url|slice:'-9:' }}"
                                    frameborder="0"
                                    allow="autoplay; fullscreen; picture-in-picture"
                                    allowfullscreen>
                                </iframe>
                            {% else %}
                                <!-- Direct video URL -->
                                <video
                                    controls
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                    src="{{ section.video_url }}">
                                    Your browser does not support the video tag.
                                </video>
                            {% endif %}
                        </div>
                        {% if section.video_caption %}
                            <p style="
                                margin-top: 12px;
                                font-style: italic;
                                color: #666;
                                font-size: 0.95em;
                            ">
                                {{ section.video_caption }}
                            </p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <div style="
            text-align: center;
            padding: 60px 20px;
            background: #f9f9f9;
            border-radius: 10px;
        ">
            <p style="font-size: 1.2em; color: #999; margin: 0;">
                No sections available yet for this module.
            </p>
        </div>
    {% endif %}

    <!-- Practice Questions Link -->
    <div style="
        margin-top: 50px;
        padding: 30px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 15px;
        text-align: center;
        color: white;
    ">
        <h3 style="margin: 0 0 15px 0; font-size: 1.4em;">Ready to Practice?</h3>
        <p style="margin: 0 0 20px 0; opacity: 0.95;">
            Test your understanding with interactive questions on {{ module.topic.name }}
        </p>
        <a href="{% url 'topic_quiz' module.topic.slug %}"
           style="
               display: inline-block;
               background: white;
               color: #f5576c;
               padding: 12px 30px;
               border-radius: 25px;
               text-decoration: none;
               font-weight: 600;
               transition: transform 0.2s;
           "
           onmouseover="this.style.transform='scale(1.05)'"
           onmouseout="this.style.transform='scale(1)'">
            Start Practice Questions ‚Üí
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- GeoGebra API -->
<script src="https://www.geogebra.org/apps/deployggb.js"></script>

<script>
    // Initialize all GeoGebra applets on the page
    document.addEventListener('DOMContentLoaded', function() {
        {% for section in sections %}
            {% if section.geogebra_enabled and section.geogebra_material_id %}
                (function() {
                    var params = {
                        "material_id": "{{ section.geogebra_material_id }}",
                        "width": {{ section.geogebra_width }},
                        "height": {{ section.geogebra_height }},
                        "showToolBar": {{ section.geogebra_show_toolbar|yesno:"true,false" }},
                        "showMenuBar": {{ section.geogebra_show_menu|yesno:"true,false" }},
                        "showAlgebraInput": false,
                        "enableShiftDragZoom": true,
                        "enableRightClick": false,
                        "capturingThreshold": null,
                        "showToolBarHelp": false,
                        "errorDialogsActive": false,
                        "useBrowserForJS": false
                    };
                    var applet = new GGBApplet(params, true);
                    applet.inject('geogebra-{{ section.id }}');
                })();
            {% endif %}
        {% endfor %}
    });
</script>
{% endblock %}
