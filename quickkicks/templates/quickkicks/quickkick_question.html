{% extends "_base.html" %}
{% load static %}

{% block title %}{{ quickkick.title }} | NumScoil{% endblock %}

{% block content %}
<div class="mx-auto w-full max-w-6xl px-6 md:px-10 py-8">

  <!-- QuickKick Video/Applet Section -->
  <div class="mb-8 rounded-2xl bg-gradient-to-r from-rose-pop to-violet-royal p-6 text-mist shadow-[0_14px_36px_rgba(148,72,176,0.28)]">
    <div class="mb-2 flex flex-wrap items-center gap-3">
      <span class="inline-flex items-center rounded-full bg-white/20 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-mist">
        {{ topic.name }}
      </span>
      {% if quickkick.duration_seconds %}
      <span class="inline-flex items-center rounded-full bg-midnight/30 px-3 py-1 text-xs font-semibold text-mist">
        ‚è± {{ quickkick.duration_seconds }}s
      </span>
      {% endif %}
    </div>
    <h1 class="mb-2 text-2xl font-semibold">{{ quickkick.title }}</h1>
    {% if quickkick.description %}
    <p class="text-mist/90">{{ quickkick.description }}</p>
    {% endif %}
  </div>

  <!-- Video/GeoGebra Content -->
  <div class="mb-8 rounded-2xl border border-indigo-deep/10 bg-white/95 shadow-[0_14px_32px_rgba(0,0,0,0.12)] overflow-hidden">
    {% if quickkick.content_type == 'video' %}
      <div class="bg-black">
        <video id="quickkick-video" class="w-full" controls autoplay style="max-height: 600px;">
          <source src="{{ quickkick.video.url }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </div>
    {% else %}
      <div class="bg-midnight/90">
        <iframe
          src="{{ quickkick.geogebra_embed_url }}"
          width="100%"
          height="600px"
          class="w-full"
          style="border: 0;"
          allowfullscreen>
        </iframe>
      </div>
      <div class="border-t border-indigo-deep/10 bg-mist/60 px-5 py-4 text-sm text-indigo-deep">
        <span class="font-semibold text-midnight">Tip:</span> Interact with the GeoGebra applet to explore the concepts dynamically.
      </div>
    {% endif %}
  </div>

  <!-- Test Question Section (hidden initially for videos) -->
  <div id="test-question-section" class="space-y-10 md:space-y-12 text-midnight text-center" data-topic-slug="{{ topic.slug }}" data-question-id="{{ question.id }}" {% if quickkick.content_type == 'video' %}style="display: none;"{% endif %}>

    <header class="space-y-1 rounded-2xl bg-gradient-to-r from-rose-pop to-violet-royal p-6 shadow-[0_14px_36px_rgba(148,72,176,0.28)]">
      <h2 class="text-2xl font-semibold text-mist text-center">Question - Test Your Understanding</h2>
      <p class="text-md p-2 text-mist">Answer the question below to check your comprehension of the {{ quickkick.content_type|lower }}</p>
    </header>

    <!-- Collapsible Hint (Question Area) -->
    {% if question.hint %}
    <div class="text-midnight">
      <details class="mx-auto max-w-2xl rounded-lg border border-violet-royal bg-violet-royal/70 px-2 py-2 text-base shadow-sm">
        <summary class="cursor-pointer font-semibold text-mist">üí° Hint</summary>
        <div class="mt-3 whitespace-pre-wrap leading-relaxed text-mist">
          {{ question.hint|safe }}
        </div>

        {% with img=question.get_image %}
        {% if img %}
        <div class="mt-3 text-center">
          <img src="{{ img }}" alt="Question image" class="mx-auto h-auto max-w-[75%] rounded-md">
        </div>
        {% endif %}
        {% endwith %}
      </details>
    </div>
    {% endif %}

    <!-- Each QuestionPart -->
    {% for part in parts %}
    <div id="part-{{ part.id }}" data-part-id="{{ part.id }}"
      class="text-lg mt-6 md:mt-8 rounded-lg border border-indigo-deep/10 bg-mist px-5 py-8 md:px-6 md:py-10 space-y-4 md:space-y-5 text-left leading-relaxed">

      <!-- Inline label + question prompt -->
      <div class="flex items-start gap-2 text-left">
        <div class="min-w-[32px] font-bold text-indigo-deep">{{ part.label }}</div>
        <div class="flex-1 leading-relaxed">{{ part.prompt|safe }}</div>
      </div>

      <!-- QuestionPart Image -->
      {% if part.image %}
      <div class="mt-3 text-center">
        <img src="{{ part.image.url }}" alt="Question part image"
          class="mx-auto h-auto max-w-[75%] rounded-md border border-indigo-deep/10">
      </div>
      {% endif %}

      <!-- ‚ú® Expected Answer Format Box -->
      {% if part.get_expected_format_display %}
      <details class="mt-3 rounded-md border border-indigo-deep/20 bg-[#f0f7ff] px-4 py-3 text-sm leading-relaxed">
        <summary class="cursor-pointer font-semibold text-indigo-deep">üí≠ Expected Answer Format
        </summary>
        <div class="mt-2 leading-relaxed">
          {{ part.get_expected_format_display|safe }}
          {% if part.answer_format_template.example %}
          <div class="mt-2 border-l-4 border-indigo-deep bg-[#e8f4f8] px-3 py-2 text-md italic">
            Example: {{ part.answer_format_template.example }}
          </div>
          {% endif %}
        </div>
      </details>
      {% endif %}

      <!-- Math input -->
      <math-field id="mf-{{ part.id }}"
        class="mt-2 block w-full rounded-md border border-indigo-deep/20 px-3 py-2 text-base shadow-sm"></math-field>

      <!-- Buttons and feedback -->
      <div class="mt-4 flex items-center gap-4">
        <button type="button" class="check-btn inline-flex items-center rounded-md bg-indigo-deep px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-deep" data-part="{{ part.id }}">
          Check Answer
        </button>
        <div id="feedback-{{ part.id }}" class="hidden text-sm"></div>
      </div>

      <!-- Part Solution -->
      {% if part.solution or part.solution_image %}
      <details class="mt-4 rounded-md border border-[#a5d6a7] bg-[#e8f5e9] px-4 py-3 text-base leading-relaxed">
        <summary class="cursor-pointer font-semibold text-[#2e7d32]">üìù Solution for {{ part.label }}</summary>
        <div class="mt-2 leading-relaxed">
          {% if part.solution %}
          {{ part.solution|safe }}
          {% endif %}

          {% if part.solution_image %}
          <div class="mt-4 text-center">
            <img src="{{ part.solution_image.url }}" alt="Solution for {{ part.label }}"
              class="mx-auto h-auto max-w-full rounded-lg shadow-md">
          </div>
          {% endif %}
        </div>
      </details>
      {% endif %}
    </div>
    {% endfor %}

    <!-- Full question solution -->
    {% if question.solution %}
    <div id="solution-wrapper" class="mt-8 border-t border-indigo-deep/15 pt-5">
      <button id="show-solution-btn" class="inline-flex items-center rounded-md bg-lime-glow px-3 py-2 text-sm font-semibold text-midnight shadow-sm transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-lime-glow">
        üíö Show Full Solution
      </button>

      <div id="solution-content" class="mt-4 hidden leading-relaxed space-y-4">
        {{ question.solution|safe }}

        {% if question.solution_image %}
        <div class="mt-4 text-center">
          <img src="{{ question.solution_image.url }}" alt="Solution image"
            class="mx-auto h-auto max-w-[75%] rounded-lg">
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>

  <!-- Back to QuickKicks List -->
  <div class="mt-8 flex flex-wrap gap-3">
    <a href="{% url 'quickkicks:quickkicks_list' topic.slug %}"
      class="inline-flex items-center gap-2 rounded-lg bg-gradient-06 px-5 py-3 text-sm font-semibold text-mist shadow-[0_12px_26px_rgba(148,72,176,0.28)] transition hover:-translate-y-0.5 hover:shadow-[0_16px_32px_rgba(148,72,176,0.34)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-violet-royal">
      ‚Üê More {{ topic.name }} Videos
    </a>
  </div>

</div>

<!-- JavaScript for video end detection -->
{% if quickkick.content_type == 'video' %}
<script>
  // Show test question when video ends
  const video = document.getElementById('quickkick-video');
  const questionSection = document.getElementById('test-question-section');

  if (video && questionSection) {
    video.addEventListener('ended', function() {
      questionSection.style.display = 'block';
      questionSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  }
</script>
{% endif %}

<!-- Include the quiz.js for question grading (reuse from interactive_lessons) -->
<script src="{% static 'js/quiz.js' %}"></script>

{% endblock %}